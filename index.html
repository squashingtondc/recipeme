<!doctype html>
<html>

<head>
<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
<script type='text/javascript' src='http://knockoutjs.com/downloads/knockout-3.0.0.js'></script>
<script>
    function Ingredient(data) {
    this.title = ko.observable(data.title);
    this.includeInRecipe = ko.observable(data.includeInRecipe);
}

function IngredientListViewModel() {
    // Data
    var self = this;
    self.ingredients = ko.observableArray([]);
    self.newIngredientText = ko.observable();
    self.incompleteTasks = ko.computed(function () {
        return ko.utils.arrayFilter(self.ingredients(), function (ingredient) {
            return !ingredient.includeInRecipe();
        });
    });

    // Operations
    self.addIngredient = function () {
        self.ingredients.push(new Ingredient({ 
            title: this.newIngredientText(),
            includeInRecipe: true
        }));
        self.newIngredientText("");
    };
    self.removeTask = function (ingredient) {
        self.ingredients.remove(ingredient);
    };

    self.getRecipes = function () {
        // Load initial state from server, convert it to Task instances, then populate self.tasks
        var newUrl = "http://food2fork.com/api/search?key=b49f1a7e472550dd4fa5d08d735db081&q=shredded%20chicken";
        var urlTest = "http://api.yummly.com/v1/api/recipes?_app_id=246a2dfe&_app_key=575d5e01b0e7c25ab538e27743dc15db&q=onion+soup&callback=myCallback";
        var url = "http://api.yummly.com/v1/api/recipes?_app_id=246a2dfe&_app_key=575d5e01b0e7c25ab538e27743dc15db";
        if (self.ingredients().length > 0) {
            for (var i = 0; i < self.ingredients().length; i++) {
                url += "&allowedIngredient[]=" + self.ingredients()[i].title();
            }
            alert(url);
            $.support.cors = true;
            $.getJSON(newUrl, {
                //headers: { Access-Control-Allow-Origin: * },
                headers: {
                    "Content-Type": "application/json",
                        "Accept": "application/json"
                },
                contentType: "application/json",
                dataType: 'jsonp',
                xhrFields: {
                    withCredentials: true
                },
                success: function (json) {
                    // do stuff with json (in this case an array)
                    alert("Success");
                    alert(json);
                },
                error: function () {
                    alert("Error");
                }
            });


        } else {
            alert("Please enter at least one ingredient.");
        }
    };
}

function myCallback(jsonp) {
    alert("CALLBACK CALLED!");
}

ko.applyBindings(new IngredientListViewModel());

</script>

</head>

<body bgcolor="white" text="blue">

<h3>RecipeMe</h3>
<h4>What's in your cupboard?</h4>
<form data-bind="submit: addIngredient">
    Add ingredient: <input data-bind="value: newIngredientText" 
                           placeholder="What ingredient is available?" />
    <button type="submit">Add</button>
</form>

<ul data-bind="foreach: ingredients, visible: ingredients().length > 0">
    <li>
        <input type="checkbox" data-bind="checked: includeInRecipe" />
        <input data-bind="value: title, enable: includeInRecipe" />
        <a href="#" data-bind="click: $parent.removeTask">Delete</a>
    </li>
</ul>

<form data-bind="submit: getRecipes">
    <button type="submit">RecipeMe</button>
</form>

You have <b data-bind="text: incompleteTasks().length">&nbsp;</b> incomplete task(s)
<span data-bind="visible: incompleteTasks().length == 0"></span>

<textarea name="ingredients" data-bind="value: ko.toJSON(ingredients)"></textarea>

</body>

</html>

